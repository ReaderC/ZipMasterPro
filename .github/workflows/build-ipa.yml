name: Build and Release IPA

on:
  push:
    tags:
      - 'v*'  # å½“æŽ¨é€ç‰ˆæœ¬æ ‡ç­¾æ—¶è§¦å‘
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number'
        required: true
        default: '1.0.0'

jobs:
  build-ipa:
    runs-on: macos-14
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '15.4'
        
    - name: Cache build artifacts
      uses: actions/cache@v3
      with:
        path: |
          ~/Library/Developer/Xcode/DerivedData
          build/
        key: ${{ runner.os }}-build-${{ hashFiles('**/project.pbxproj') }}
        restore-keys: |
          ${{ runner.os }}-build-
          
    - name: Build and create IPA
      run: |
        echo "ðŸ”¨ å¼€å§‹æž„å»ºiOSåº”ç”¨..."
        
        # æž„å»ºåº”ç”¨
        xcodebuild -project ZipMasterPro.xcodeproj \
          -scheme ZipMasterPro \
          -configuration Release \
          -destination 'generic/platform=iOS' \
          -derivedDataPath build/ \
          clean build \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          AD_HOC_CODE_SIGNING_ALLOWED=YES \
          ARCHS="arm64" \
          ONLY_ACTIVE_ARCH=NO \
          BUILD_LIBRARY_FOR_DISTRIBUTION=NO
          
        echo "ðŸ“¦ åˆ›å»ºIPAåŒ…..."
        
        # æ‰¾åˆ°æž„å»ºçš„åº”ç”¨
        APP_PATH=$(find build/Build/Products/Release-iphoneos -name "*.app" | head -1)
        
        if [ -z "$APP_PATH" ]; then
          echo "âŒ æœªæ‰¾åˆ°.appæ–‡ä»¶"
          exit 1
        fi
        
        echo "æ‰¾åˆ°åº”ç”¨: $APP_PATH"
        
        # åˆ›å»ºPayloadç›®å½•
        mkdir -p Payload
        cp -R "$APP_PATH" Payload/
        
        # åˆ›å»ºIPAæ–‡ä»¶
        zip -r ZipMasterPro_unsigned.ipa Payload
        
        # æ¸…ç†
        rm -rf Payload
        
        echo "âœ… IPAæ–‡ä»¶åˆ›å»ºå®Œæˆ: ZipMasterPro_unsigned.ipa"
        
    - name: Get version info
      id: version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
        else
          echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
        fi
        
    - name: Create Release
      if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        name: ZipMaster Pro v${{ steps.version.outputs.version }}
        body: |
          ## ðŸŽ‰ ZipMaster Pro v${{ steps.version.outputs.version }} å‘å¸ƒï¼
          
          åŸºäºŽiOS 26 LiquidGlassè®¾è®¡è¯­è¨€çš„å¼ºå¤§è§£åŽ‹ç¼©å·¥å…·ã€‚
          
          ### âœ¨ æ–°åŠŸèƒ½
          - æ”¯æŒå¤šç§åŽ‹ç¼©æ ¼å¼ (ZIP, 7Z, RAR, TAR, GZIP, BZIP2)
          - AES-256å†›ç”¨çº§åŠ å¯†
          - æ™ºèƒ½åˆ†å·åŽ‹ç¼©
          - LiquidGlassæ¯›çŽ»ç’ƒè®¾è®¡æ•ˆæžœ
          
          ### ðŸ“± å®‰è£…è¯´æ˜Ž
          è¿™æ˜¯ä¸€ä¸ªæœªç­¾åçš„IPAæ–‡ä»¶ï¼Œé€‚ç”¨äºŽæµ‹è¯•å’Œå¼€å‘ç›®çš„ã€‚
          
          **å®‰è£…æ–¹æ³•ï¼š**
          1. ä½¿ç”¨Xcodeå®‰è£…ï¼šè¿žæŽ¥è®¾å¤‡ï¼Œæ‹–æ‹½IPAåˆ°Devicesçª—å£
          2. ä½¿ç”¨AltStoreå®‰è£…ï¼šé€šè¿‡AltStoreåº”ç”¨å®‰è£…
          3. ä½¿ç”¨Sideloadlyå®‰è£…ï¼šé€šè¿‡Sideloadlyå·¥å…·å®‰è£…
          4. è¶Šç‹±è®¾å¤‡ï¼šä½¿ç”¨AppSync Unifiedå®‰è£…
          
          ### âš ï¸ é‡è¦æé†’
          - æ­¤IPAæ–‡ä»¶ä¸ºæœªç­¾åç‰ˆæœ¬ï¼Œä»…ç”¨äºŽæµ‹è¯•å’Œå¼€å‘
          - éœ€è¦iOS 17.0æˆ–æ›´é«˜ç‰ˆæœ¬
          - å•†ä¸šä½¿ç”¨éœ€è¦ç›¸åº”çš„å¼€å‘è€…è¯ä¹¦
          
          ### ðŸ”§ æŠ€æœ¯ä¿¡æ¯
          - **æž„å»ºçŽ¯å¢ƒ**: GitHub Actions + macOS 14 + Xcode 15.4
          - **ç›®æ ‡å¹³å°**: iOS 17.0+
          - **æž¶æž„**: arm64
          - **å¤§å°**: çº¦ 5MB
          
          æ„Ÿè°¢ä½¿ç”¨ZipMaster Proï¼
        files: ZipMasterPro_unsigned.ipa
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Upload IPA as artifact (for workflow_dispatch)
      if: github.event_name == 'workflow_dispatch'
      uses: actions/upload-artifact@v4
      with:
        name: ZipMasterPro-v${{ steps.version.outputs.version }}-unsigned
        path: ZipMasterPro_unsigned.ipa
        retention-days: 90
        
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts
        path: |
          build/
          !build/Build/Intermediates.noindex/
        retention-days: 7
        
    - name: Success notification
      run: |
        echo "ðŸŽ‰ æž„å»ºå®Œæˆï¼"
        echo "ðŸ“± IPAæ–‡ä»¶å·²ç”Ÿæˆ: ZipMasterPro_unsigned.ipa"
        echo "ðŸ”§ ç‰ˆæœ¬: ${{ steps.version.outputs.version }}"
        echo "ðŸ“¦ æ–‡ä»¶å¤§å°: $(ls -lh ZipMasterPro_unsigned.ipa | awk '{print $5}')"
        
    - name: Cleanup on failure
      if: failure()
      run: |
        echo "âŒ æž„å»ºå¤±è´¥"
        echo "æ£€æŸ¥æž„å»ºæ—¥å¿—èŽ·å–è¯¦ç»†ä¿¡æ¯"
        # ä¿ç•™æž„å»ºæ—¥å¿—ä»¥ä¾›è°ƒè¯•
        mkdir -p failure-logs
        cp -r ~/Library/Developer/Xcode/DerivedData/*/Logs/ failure-logs/ 2>/dev/null || true