name: Build iOS App

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-14  # 使用最新的macOS运行器
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '15.4'  # 使用最新的Xcode版本
        
    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/Library/Developer/Xcode/DerivedData
          ~/.cocoapods
        key: ${{ runner.os }}-dependencies-${{ hashFiles('**/Podfile.lock') }}
        restore-keys: |
          ${{ runner.os }}-dependencies-
          
    - name: Show Xcode and macOS versions
      run: |
        xcodebuild -version
        sw_vers
        
    - name: List available devices
      run: |
        xcrun xctrace list devices
        
    - name: Build for iOS Simulator
      run: |
        xcodebuild -project ZipMasterPro.xcodeproj \
          -scheme ZipMasterPro \
          -configuration Debug \
          -destination 'platform=iOS Simulator,name=iPhone 15,OS=latest' \
          clean build \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO
          
    - name: Build for iOS Device (Unsigned)
      run: |
        # 首先尝试用scheme构建
        echo "=== Building with scheme ==="
        if xcodebuild -project ZipMasterPro.xcodeproj \
          -scheme ZipMasterPro \
          -configuration Release \
          -destination 'generic/platform=iOS' \
          -derivedDataPath build \
          clean build \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          ARCHS="arm64" \
          ONLY_ACTIVE_ARCH=NO; then
          echo "=== Build with scheme successful ==="
        else
          echo "=== Build with scheme failed, trying with target ==="
          # 如果scheme构建失败，尝试用target构建
          xcodebuild -project ZipMasterPro.xcodeproj \
            -target ZipMasterPro \
            -configuration Release \
            -destination 'generic/platform=iOS' \
            -derivedDataPath build \
            clean build \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            ARCHS="arm64" \
            ONLY_ACTIVE_ARCH=NO
        fi

    - name: Debug Build Directory Structure
      run: |
        echo "=== Build Directory Structure ==="
        find build -type d | head -20
        echo ""
        echo "=== All Files in Build Directory ==="
        find build -type f | head -20
        echo ""
        echo "=== Looking for .app files ==="
        find build -name "*.app" -type d
        echo ""
        echo "=== Looking for Products Directory ==="
        find build -name "Products" -type d

    - name: Create IPA package
      run: |
        # 尝试多种可能的.app文件路径
        APP_PATH=""

        echo "=== Searching for .app file ==="

        # 首先尝试标准的Xcode构建路径
        STANDARD_PATHS=(
          "build/Build/Products/Release-iphoneos/ZipMasterPro.app"
          "build/Build/Products/Release-iphoneos/*.app"
        )

        for path in "${STANDARD_PATHS[@]}"; do
          echo "Checking standard path: $path"
          if [ -d "$path" ]; then
            APP_PATH="$path"
            echo "Found app at: $APP_PATH"
            break
          fi
        done

        # 如果标准路径没有找到，使用find命令搜索
        if [ -z "$APP_PATH" ]; then
          echo "Standard paths not found, searching with find..."
          APP_PATH=$(find build -name "ZipMasterPro.app" -type d | head -1)
          if [ -n "$APP_PATH" ]; then
            echo "Found app with find: $APP_PATH"
          fi
        fi

        # 如果还是没找到，尝试查找任何.app文件
        if [ -z "$APP_PATH" ]; then
          echo "No ZipMasterPro.app found, looking for any .app file..."
          APP_PATH=$(find build -name "*.app" -type d | head -1)
          if [ -n "$APP_PATH" ]; then
            echo "Found .app file: $APP_PATH"
          fi
        fi

        if [ -z "$APP_PATH" ]; then
          echo "Error: No .app file found!"
          echo "Build directory contents:"
          ls -la build/ 2>/dev/null || echo "build directory not accessible"
          if [ -d "build/Build" ]; then
            echo "Build/Build contents:"
            ls -la build/Build/
          fi
          exit 1
        fi

        # 验证.app文件结构
        echo "=== App file structure ==="
        ls -la "$APP_PATH"

        # 创建应用包目录结构
        mkdir -p payload
        cp -R "$APP_PATH" payload/

        # 验证复制是否成功
        if [ ! -d "payload/ZipMasterPro.app" ]; then
          echo "Error: Failed to copy app to payload directory"
          ls -la payload/
          exit 1
        fi

        # 创建IPA文件
        cd payload
        zip -r ../ZipMasterPro_unsigned.ipa .
        cd ..

        # 验证IPA文件是否创建成功
        if [ ! -f "ZipMasterPro_unsigned.ipa" ]; then
          echo "Error: IPA file not created"
          exit 1
        fi

        echo "IPA file created successfully"
        ls -la ZipMasterPro_unsigned.ipa

        # 清理临时文件
        rm -rf payload
        
    - name: Upload IPA artifact
      uses: actions/upload-artifact@v4
      with:
        name: ZipMasterPro-IPA
        path: ZipMasterPro_unsigned.ipa
        retention-days: 30
        
    - name: Upload build logs
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          ~/Library/Developer/Xcode/DerivedData/*/Logs/
        retention-days: 7