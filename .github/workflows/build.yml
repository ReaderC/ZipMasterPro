name: Build iOS App

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-14  # 使用最新的macOS运行器
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '15.4'  # 使用最新的Xcode版本
        
    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/Library/Developer/Xcode/DerivedData
          ~/.cocoapods
        key: ${{ runner.os }}-dependencies-${{ hashFiles('**/Podfile.lock') }}
        restore-keys: |
          ${{ runner.os }}-dependencies-
          
    - name: Show Xcode and macOS versions
      run: |
        xcodebuild -version
        sw_vers
        
    - name: List available devices
      run: |
        xcrun xctrace list devices
        
    - name: Build for iOS Simulator
      run: |
        xcodebuild -project ZipMasterPro.xcodeproj \
          -scheme ZipMasterPro \
          -configuration Debug \
          -destination 'platform=iOS Simulator,name=iPhone 15,OS=latest' \
          clean build \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO
          
    - name: Build for iOS Device (Unsigned)
      run: |
        xcodebuild -project ZipMasterPro.xcodeproj \
          -scheme ZipMasterPro \
          -configuration Release \
          -destination 'generic/platform=iOS' \
          clean build \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          ARCHS="arm64" \
          ONLY_ACTIVE_ARCH=NO
          
    - name: Create IPA package
      run: |
        # 创建应用包目录结构
        mkdir -p payload
        cp -R build/Release-iphoneos/ZipMasterPro.app payload/
        
        # 创建IPA文件
        cd payload
        zip -r ../ZipMasterPro_unsigned.ipa .
        cd ..
        
        # 清理临时文件
        rm -rf payload
        
    - name: Upload IPA artifact
      uses: actions/upload-artifact@v4
      with:
        name: ZipMasterPro-IPA
        path: ZipMasterPro_unsigned.ipa
        retention-days: 30
        
    - name: Upload build logs
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          ~/Library/Developer/Xcode/DerivedData/*/Logs/
        retention-days: 7