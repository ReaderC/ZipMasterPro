name: Build iOS App

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-14  # 使用最新的macOS运行器
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '15.4'  # 使用最新的Xcode版本
        
    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/Library/Developer/Xcode/DerivedData
          ~/.cocoapods
        key: ${{ runner.os }}-dependencies-${{ hashFiles('**/Podfile.lock') }}
        restore-keys: |
          ${{ runner.os }}-dependencies-
          
    - name: Show Xcode and macOS versions
      run: |
        xcodebuild -version
        sw_vers
        
    - name: List available devices
      run: |
        xcrun xctrace list devices
        
    - name: Build for iOS Simulator
      run: |
        xcodebuild -project ZipMasterPro.xcodeproj \
          -scheme ZipMasterPro \
          -configuration Debug \
          -destination 'platform=iOS Simulator,name=iPhone 15,OS=latest' \
          clean build \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO
          
    - name: Build for iOS Device (Unsigned)
      run: |
        # 首先尝试用scheme构建
        echo "=== Building with scheme ==="
        if xcodebuild -project ZipMasterPro.xcodeproj \
          -scheme ZipMasterPro \
          -configuration Release \
          -destination 'generic/platform=iOS' \
          -derivedDataPath build \
          clean build \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          ARCHS="arm64" \
          ONLY_ACTIVE_ARCH=NO; then
          echo "=== Build with scheme successful ==="
        else
          echo "=== Build with scheme failed, trying with target ==="
          # 如果scheme构建失败，尝试用target构建
          xcodebuild -project ZipMasterPro.xcodeproj \
            -target ZipMasterPro \
            -configuration Release \
            -destination 'generic/platform=iOS' \
            -derivedDataPath build \
            clean build \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            ARCHS="arm64" \
            ONLY_ACTIVE_ARCH=NO
        fi

    - name: Debug Build Directory Structure
      run: |
        echo "=== Complete Build Directory Analysis ==="
        echo ""

        # 检查build目录是否存在
        if [ ! -d "build" ]; then
          echo "ERROR: build directory does not exist!"
          echo "Current directory contents:"
          ls -la
          exit 1
        fi

        echo "1. Build directory root contents:"
        ls -la build/
        echo ""

        # 递归显示完整目录结构
        echo "2. Complete directory tree:"
        find build -type d | sort
        echo ""

        # 显示所有文件
        echo "3. All files in build directory:"
        find build -type f | sort
        echo ""

        # 特别查找.app文件
        echo "4. Searching for .app directories:"
        find build -name "*.app" -type d
        echo ""

        # 查找Products目录
        echo "5. Searching for Products directories:"
        find build -name "*Products*" -type d
        echo ""

        # 查找任何包含"Release"的目录
        echo "6. Searching for Release-related directories:"
        find build -name "*Release*" -type d
        echo ""

        # 查找任何包含"iphoneos"的目录
        echo "7. Searching for iphoneos directories:"
        find build -name "*iphoneos*" -type d
        echo ""

        # 检查DerivedData路径的可能性
        echo "8. Checking for standard DerivedData structure:"
        for possible_path in \
          "build/Build/Products/Release-iphoneos" \
          "build/Build/Products" \
          "build/Products" \
          "build/Release-iphoneos"; do
          if [ -d "$possible_path" ]; then
            echo "Found: $possible_path"
            ls -la "$possible_path"
          fi
        done

    - name: Create IPA package
      run: |
        echo "=== IPA Creation Process ==="
        echo ""

        # 更智能的.app文件搜索
        APP_PATH=""

        # 方法1: 查找精确的.app名称
        echo "Method 1: Searching for exact app name..."
        APP_PATH=$(find build -name "ZipMasterPro.app" -type d | head -1)

        # 方法2: 查找任何.app文件
        if [ -z "$APP_PATH" ]; then
          echo "Method 2: Searching for any .app file..."
          APP_PATH=$(find build -name "*.app" -type d | head -1)
        fi

        # 方法3: 查看可执行文件并推断.app位置
        if [ -z "$APP_PATH" ]; then
          echo "Method 3: Looking for executable files..."
          EXECUTABLE=$(find build -name "ZipMasterPro" -type f -perm +111 | head -1)
          if [ -n "$EXECUTABLE" ]; then
            APP_PATH=$(dirname "$EXECUTABLE")
            echo "Found executable, app might be at: $APP_PATH"
            # 检查父目录是否是.app目录
            if [[ "$APP_PATH" != *.app ]]; then
              APP_PATH=$(dirname "$APP_PATH")
            fi
          fi
        fi

        if [ -z "$APP_PATH" ]; then
          echo "ERROR: No .app file found using any method!"
          echo ""
          echo "Final attempt - showing everything in build directory:"
          find build | head -50
          exit 1
        fi

        echo "SUCCESS: Found app at: $APP_PATH"
        echo ""

        # 验证.app文件内容
        echo "=== Verifying .app structure ==="
        if [ ! -d "$APP_PATH" ]; then
          echo "ERROR: App path is not a directory: $APP_PATH"
          exit 1
        fi

        echo "Contents of .app directory:"
        ls -la "$APP_PATH"
        echo ""

        # 检查必需的文件
        REQUIRED_FILES=("Info.plist" "ZipMasterPro")
        for file in "${REQUIRED_FILES[@]}"; do
          if [ ! -e "$APP_PATH/$file" ]; then
            echo "WARNING: Required file not found: $APP_PATH/$file"
          else
            echo "✓ Found: $file"
          fi
        done
        echo ""

        # 创建payload目录并复制应用
        echo "=== Creating IPA package ==="
        mkdir -p payload
        APP_NAME=$(basename "$APP_PATH")
        echo "Copying $APP_NAME to payload directory..."
        cp -R "$APP_PATH" "payload/"

        # 验证复制
        if [ ! -d "payload/$APP_NAME" ]; then
          echo "ERROR: Failed to copy app to payload"
          ls -la payload/
          exit 1
        fi

        echo "✓ App copied successfully to payload/$APP_NAME"

        # 创建IPA文件
        echo "Creating IPA file..."
        cd payload
        zip -r "../ZipMasterPro_unsigned.ipa" .
        cd ..

        # 验证IPA文件
        if [ ! -f "ZipMasterPro_unsigned.ipa" ]; then
          echo "ERROR: IPA file was not created!"
          ls -la
          exit 1
        fi

        echo "✓ IPA file created successfully!"
        echo "IPA file details:"
        ls -la ZipMasterPro_unsigned.ipa

        # 验证IPA内容（可选调试）
        echo ""
        echo "IPA file contents preview:"
        unzip -l ZipMasterPro_unsigned.ipa | head -20

        # 清理
        rm -rf payload
        
    - name: Upload IPA artifact
      uses: actions/upload-artifact@v4
      with:
        name: ZipMasterPro-IPA
        path: ZipMasterPro_unsigned.ipa
        retention-days: 30
        
    - name: Upload build logs
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          ~/Library/Developer/Xcode/DerivedData/*/Logs/
        retention-days: 7